name: Build & Publish Plugins

on:
  push:
    branches:
      - main
    paths:
      - 'plugforge-starter/**'
      - 'platforms/**'
      - 'lib/**'
      - '.github/workflows/publish.yml'
  workflow_dispatch:

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - platform: cc
            name: Claude Code
          - platform: gc
            name: Gemini CLI
          - platform: oc
            name: OpenCode
          - platform: vscode
            name: VS Code
          - platform: cursor
            name: Cursor
          - platform: zed
            name: Zed
          - platform: jetbrains
            name: JetBrains
          - platform: copilot-cli
            name: GitHub Copilot CLI

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Build plugin for ${{ matrix.name }}
        run: node cli.js plugforge-starter /tmp/build

      - name: Setup Git
        run: |
          git config --global user.email "noreply@github.com"
          git config --global user.name "plugforge-bot"

      - name: Publish ${{ matrix.name }} to GitHub
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PLATFORM: ${{ matrix.platform }}
          PLATFORM_NAME: ${{ matrix.name }}
        run: |
          set -e
          REPO_NAME="glootie-${PLATFORM}"
          REPO_URL="https://github.com/AnEntrypoint/${REPO_NAME}.git"
          WORK_DIR="/tmp/${REPO_NAME}-work"
          BUILD_DIR="/tmp/build/glootie-${PLATFORM}"
          
          echo "ðŸ”§ Setting up repository: ${REPO_NAME}"
          
          # Create work directory
          mkdir -p "${WORK_DIR}"
          cd "${WORK_DIR}"
          
          # Check if repo exists, create if needed
          if gh repo view "AnEntrypoint/${REPO_NAME}" >/dev/null 2>&1; then
            echo "âœ“ Repository exists, pulling latest..."
            git clone "${REPO_URL}" . 2>/dev/null || git init
            git remote set-url origin "${REPO_URL}" || git remote add origin "${REPO_URL}"
            git fetch origin main 2>/dev/null || true
            git checkout main 2>/dev/null || git checkout -b main
          else
            echo "âœ“ Creating new repository..."
            gh repo create "AnEntrypoint/${REPO_NAME}" \
              --description "Glootie plugin for ${PLATFORM_NAME}" \
              --public \
              --source=. \
              --push=false \
              --remote=origin || echo "Repository may already exist"
            git init
            git remote add origin "${REPO_URL}"
            git checkout -b main
          fi
          
          # Clear and copy new build
          echo "ðŸ“¦ Copying build artifacts..."
          find . -maxdepth 1 -type f -not -name '.gitkeep' -delete
          find . -maxdepth 1 -type d -not -name '.' -not -name '.git' -exec rm -rf {} + 2>/dev/null || true
          cp -r "${BUILD_DIR}"/* . 2>/dev/null || true
          
          # Commit and push
          echo "ðŸ“¤ Publishing to GitHub..."
          git add -A
          
          if git diff-index --quiet HEAD --; then
            echo "âœ“ No changes to commit"
          else
            git commit -m "ðŸ¤– Auto-build: ${PLATFORM_NAME} plugin update from plugforge

Generated by GitHub Actions on $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
            
            git push -u origin main -f || git push -u origin HEAD:main -f
            echo "âœ“ Published successfully"
          fi

  notify:
    needs: build-and-publish
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Summary
        run: |
          echo "âœ… Build & Publish Complete"
          echo "All 8 platform repositories updated:"
          echo "  - glootie-cc (Claude Code)"
          echo "  - glootie-gc (Gemini CLI)"
          echo "  - glootie-oc (OpenCode)"
          echo "  - glootie-vscode (VS Code)"
          echo "  - glootie-cursor (Cursor)"
          echo "  - glootie-zed (Zed)"
          echo "  - glootie-jetbrains (JetBrains)"
          echo "  - glootie-copilot-cli (GitHub Copilot CLI)"
